# 更新日志

风花雪乐(风花雪月)更新日志。
本项目的所有重要更改都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/spec/v2.0.0.html)。

## [1.1.2] - 2026-01-31

### 新增

- **权限请求**: 应用启动时请求必要权限（通知、网络等），提升首次使用体验；增强 iOS 局域网访问时的网络权限触发逻辑。
- **设置直达**: 支持通过路由参数直接打开设置页面指定部分（如 `?section=xxx`）；登录/连接成功后检查设置与当前连接 host/port 是否一致，不一致时提示用户。
- **添加到歌单**: 播放页支持将当前歌曲添加到现有歌单或新建歌单。
- **URL 修复**: 新增拦截器，将后端返回的内网地址（如 192.168.x.x）替换为当前配置的服务器地址，确保客户端能正确访问音频与封面。
- **设备切换防抖**: 使用 RxDart 实现设备切换防抖（200ms），避免快速点击导致的连接冲突。
- **封面与图标**: 歌单/歌曲封面默认图标增加渐变、阴影与纹理，统一圆角与主题适配。

### 改进

- **音频与播放器**: 优化音频处理逻辑，移除手动打断处理以兼容 just_audio；更新播放器状态栏显示逻辑，简化设备选择界面；优化事件监听。
- **前台与保活**: 远程播放时调整前台服务与 bufferedPosition，提升 MIUI 等系统上的保活与进度条显示；移除播放列表封面冗余阴影。
- **状态持久化**: 提取状态持久化基准更新逻辑为独立方法；状态保存计时器在关键状态变化时防饿死，位置更新改为节流。
- **音乐库**: 移除未使用的「全部歌曲」相关代码，简化 `library_page` 结构与依赖。
- **MediaItem 同步**: 强制更新 MediaItem，确保状态栏/控制中心与当前歌曲一致。

### 修复

- **时长与 iOS**: 修复时长不展示与 iOS 掉后台问题。
- **设备切换**: 修复设备切换期间的竞态与状态不一致；远程切换改为热挂起，消除 MediaCodec 竞态，切回本地秒开；修复 App 重启后僵尸 UI（显示播放但实际已停）。
- **并发与缓存**: 修复 AudioHandler/LocalPlayerController 并发竞态；缓存代理失败时自动降级为在线播放，保留封面信息；忽略切歌等场景下的预期网络中断错误。
- **刷新与缓存**: 修复刷新时 UI 闪烁；优化缓存监听（skipLoadingOnRefresh、select 监听），避免 loading 触发重建。
- **播放状态**: 修复因 MediaItem 未变更导致状态栏/控制中心不刷新的问题。

## [1.1.1] - 2026-01-24

### 新增

- **设备管理**: 支持一键关闭所有设备，显示所有设备当前状态。
- **快速切换设备**: 增加首页快速切换设备入口，支持在设置中控制显隐。
- **设备信息**: 显示设备名称，便于识别不同设备。
- **播放页功能**: 播放页支持删除歌曲。
- **定时暂停**: 本地播放支持定时暂停功能。
- **版本更新提示**: 新增版本更新提示功能。
- **应用图标**: 更换应用 Logo。

### 改进

- **播放体验**: 修复切换歌曲时状态栏时长不统一的问题，修复本地播放状态恢复时播放模式丢失的问题，修复本地播放不显示进度的问题。
- **交互优化**: 优化搜索入口交互体验，修复更多弹窗圆角显示问题。
- **兼容性**: 修复本地设备统一使用 BaseConstants.webDevice 后，老版本本机播放缓存失效的问题，兼容后端接口 playlistnames 查询自定义歌单存在的问题。
- **iOS 支持**: iOS 补充连接网络权限配置，兼容 iOS 系统支持后台播放，兼容底部安全区显示。
- **UI 优化**: 全部图标统一使用圆角设计，移除不美观的播放特效。
- **其他**: 优化版本检查避免重复检查，增加日志输出便于问题排查。

## [1.1.0] - 2026-01-21

### 新增

- **自定义歌单管理**: 支持创建新的自定义歌单，删除现有歌单。
- **歌单排序**: 支持长按拖拽调整歌单顺序。
- **批量管理**: 在歌单管理页面支持批量选中歌单，进行隐藏、显示或删除操作。
- **歌曲管理**: 支持向自定义歌单中添加歌曲或从中移除歌曲。

### 改进

- **检查更新**: 优化检查更新逻辑,支持展示更新内容
- **远程模式**: 修复播放模式切换问题
- **用户界面**: ICON 全部圆角,音乐库展示歌曲数量,播放界面展示当前播放设备

## [1.0.0] - 2026-01-18

### 新增

- **多端连接**: 支持通过账号密码连接 xiaomusic 服务端。
- **音乐播放**: 完整的播放控制功能（播放/暂停、切歌、进度调节、循环/随机模式）。
- **歌单管理**: 支持查看歌单列表、收藏歌曲、查看自定义歌单。
- **多设备控制**: 可选择本机播放或控制服务端连接的设备播放。
- **下载管理**: 支持查看服务端的下载任务状态。
- **工具箱**: 支持管理服务端的定时任务。
- **个性化**: 支持深色/浅色主题模式切换。
- **设置管理**: 丰富的服务端配置选项（目录设置、TTS 设置、账号设置等）。
