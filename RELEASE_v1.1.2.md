# 风花雪乐 v1.1.2 发布说明

**发布日期**: 2026-01-31  
**对比基准**: v1.1.1（commit f320e37「v1.1.1写更新日志」）

## 概述

v1.1.2 在 v1.1.1 基础上，包含 **20 个提交**，涉及权限与设置、播放与设备切换、状态同步、封面与 UI、并发与缓存等多方面改进与修复。

## 新增功能

- **启动时权限请求**：应用首次启动时请求通知、网络等必要权限；增强 iOS 访问局域网时的网络权限触发逻辑。
- **设置页直达与连接校验**：支持通过路由参数直接打开设置页指定部分；登录/连接成功后若设置与当前连接 host/port 不一致会提示用户。
- **添加到歌单**：播放页支持将当前歌曲添加到现有歌单或新建歌单。
- **URL 修复拦截器**：将后端返回的内网地址替换为当前配置的服务器地址，确保音频与封面可正确访问。
- **设备切换防抖**：使用 RxDart 实现 200ms 防抖，避免快速点击导致连接冲突。
- **封面与默认图标**：歌单/歌曲封面默认图标增加渐变、阴影与纹理，统一圆角与主题适配。

## 改进与优化

- **音频与播放器**：优化音频处理逻辑、与 just_audio 兼容；更新播放器状态栏与设备选择界面；优化事件监听。
- **前台与保活**：远程播放时调整前台服务与进度显示，提升保活能力；统一播放列表封面样式。
- **状态持久化**：状态持久化逻辑抽取为独立方法；状态保存计时器防饿死，位置更新节流。
- **音乐库**：移除未使用的「全部歌曲」相关代码，简化页面结构。
- **MediaItem 同步**：强制更新 MediaItem，确保状态栏/控制中心与当前歌曲一致。

## 修复

- **时长与 iOS**：修复时长不展示与 iOS 掉后台问题。
- **设备切换**：修复设备切换竞态与状态不一致；远程切换改为热挂起，消除 MediaCodec 竞态、切回本地秒开；修复 App 重启后「显示播放但实际已停」的僵尸 UI。
- **并发与缓存**：修复并发竞态；缓存代理失败时自动降级为在线播放；忽略切歌等预期网络中断错误。
- **刷新与缓存**：修复刷新时 UI 闪烁；优化缓存监听，避免 loading 触发不必要重建。
- **播放状态**：修复因 MediaItem 未变更导致状态栏/控制中心不刷新的问题。

## 与 v1.1.1 的差异统计

- **提交数**: 20 个（f320e37..HEAD）
- **文件变更**: 33 个文件，约 +1749 / -991 行

## 升级建议

- 从 v1.1.1 升级：直接安装新版本即可，无数据迁移。
- 若曾遇到设备切换报错、切歌后状态栏不更新、刷新闪烁、时长不显示或 iOS 掉后台等问题，建议升级到本版本。

---

完整历史更新见 [CHANGELOG.md](CHANGELOG.md)。
