# 风花雪乐 v1.1.2 - 2026-01-31

本次更新在 v1.1.1 基础上包含 **20 个提交**，主要涉及权限与设置、播放与设备切换、状态同步、封面与 UI、并发与缓存等多方面改进与修复。

## 🎉 新增

- **启动时权限请求**：应用首次启动时请求通知、网络等必要权限；增强 iOS 访问局域网时的网络权限触发逻辑。
- **设置页直达与连接校验**：支持通过路由参数直接打开设置页指定部分；登录/连接成功后若设置与当前连接 host/port 不一致会提示用户。
- **添加到歌单**：播放页支持将当前歌曲添加到现有歌单或新建歌单。
- **URL 修复拦截器**：将后端返回的内网地址替换为当前配置的服务器地址，确保音频与封面可正确访问。
- **设备切换防抖**：使用 RxDart 实现 200ms 防抖，避免快速点击导致连接冲突。
- **封面与默认图标**：歌单/歌曲封面默认图标增加渐变、阴影与纹理，统一圆角与主题适配。

## 🚀 改进

- **音频与播放器**：重构音频处理逻辑，移除手动打断处理，确保与 just_audio 更好兼容；更新播放器状态栏与设备选择界面；优化事件监听。
- **设备选择**：简化设备选择界面，优化交互体验，使设备切换更流畅。
- **前台与保活**：远程播放时调整前台服务与进度显示，提升保活能力；统一播放列表封面样式。
- **状态持久化**：状态持久化逻辑抽取为独立方法；状态保存计时器防饿死，位置更新节流。
- **音乐库**：移除未使用的「全部歌曲」相关代码，简化页面结构。
- **MediaItem 同步**：强制更新 MediaItem，确保状态栏/控制中心与当前歌曲一致。

## 🐛 修复

- **时长与 iOS**：修复时长不展示与 iOS 掉后台问题；修复 iOS 设备在后台播放时容易掉线/中断的问题。
- **设备切换**：修复设备切换竞态与状态不一致；远程切换改为热挂起，消除 MediaCodec 竞态、切回本地秒开；修复 App 重启后「显示播放但实际已停」的僵尸 UI。
- **并发与缓存**：修复并发竞态；缓存代理失败时自动降级为在线播放；忽略切歌等预期网络中断错误。
- **刷新与缓存**：修复刷新时 UI 闪烁；优化缓存监听，避免 loading 触发不必要重建。
- **播放状态**：修复因 MediaItem 未变更导致状态栏/控制中心不刷新的问题。

## 安装包说明（按设备 CPU 架构选择）

- mi_music-release.apk：通用安装包，不知道装哪个就选他
- mi_music-arm64-v8a-release.apk：适用于绝大多数近年的安卓真机（64 位 ARM），优先推荐下载这个
- mi_music-armeabi-v7a-release.apk：适用于较老的安卓设备（32 位 ARM）
- mi_music-x86_64-release.apk：适用于 x86_64 设备/模拟器（常见于 Android Emulator、部分 Intel 设备/Chromebook）
- mi_music.ipa：iOS 安装包

---
**Full Changelog**: https://github.com/jokezc/mi_music/compare/v1.1.1...v1.1.2
