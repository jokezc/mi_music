# 错误监听文档

本文档整理了应用中所有通过友盟U-APM SDK监听的错误，用于帮助开发者快速定位和解决问题。

## 一、全局错误监听

### 1. Flutter框架异常
- **位置**: `lib/main.dart` - `_setupErrorHandling()` 中的 `FlutterError.onError`
- **目的**: 捕获Flutter框架层面的异常（如Widget构建错误、渲染错误等）
- **上报信息**:
  - 错误对象和堆栈信息
  - 上下文信息：`library`（异常来源库）、`context`（异常上下文）
- **触发条件**: 任何Flutter框架层面的未捕获异常

### 2. Platform异常
- **位置**: `lib/main.dart` - `_setupErrorHandling()` 中的 `PlatformDispatcher.instance.onError`
- **目的**: 捕获平台层面的异常（Flutter 3.3+）
- **上报信息**: 错误对象和堆栈信息
- **触发条件**: 任何平台层面的未捕获异常

### 3. 异步异常
- **位置**: `lib/main.dart` - `main()` 中的 `runZonedGuarded`
- **目的**: 捕获异步代码中未捕获的异常
- **上报信息**: 错误对象和堆栈信息
- **触发条件**: 任何在 `runZonedGuarded` 范围内未捕获的异步异常

## 二、业务错误监听

### 4. 登录错误
- **位置**: `lib/presentation/pages/login_page.dart` - `_connect()` 方法
- **目的**: 监控登录过程中的错误，通过上报服务器URL帮助开发者快速定位是哪个服务器出现问题
- **上报信息**:
  - 错误消息和堆栈信息
  - 上下文信息：
    - `error_type`: 错误类型（`auth_failed` 或 `connection_error`）
    - `server_url`: 服务器URL（**用于追溯问题，不包含用户名密码等敏感信息**）
    - `has_username`: 是否有用户名（只记录布尔值，不记录具体用户名）
- **触发条件**:
  - 认证失败（401错误）
  - 连接错误（网络错误、超时等）
  - 登录过程中的未预期异常

### 5. API请求错误
- **位置**: `lib/data/providers/api_provider.dart` - `SimpleLogInterceptor.onError()`
- **目的**: 监控API调用中的网络错误、服务器错误等，帮助开发者快速定位API问题
- **上报信息**:
  - 错误消息和堆栈信息
  - 上下文信息：
    - `api_path`: API路径
    - `status_code`: HTTP状态码
    - `error_type`: 错误类型（DioException类型）
    - `base_url`: 服务器基础URL（**用于追溯问题**）
- **触发条件**: 
  - 网络错误（连接失败、超时等）
  - 服务器错误（500、502、503等）
  - 客户端错误（400、403、404等，**但不包括401认证错误**，因为401是正常的认证流程）
- **排除**: 401认证错误不上报（这是正常的认证失败流程，不是异常错误）

### 6. 播放器错误
- **位置**: `lib/data/services/audio_handler.dart` - `_player.playbackEventStream` 的 `onError` 回调
- **目的**: 监控音频播放过程中的错误（如文件损坏、网络中断、解码失败等），帮助开发者快速定位播放问题
- **上报信息**:
  - 错误对象和堆栈信息
  - 上下文信息：
    - `current_song`: 当前播放的歌曲名称
    - `is_remote_mode`: 是否处于远程模式
    - `has_playlist`: 是否有播放列表
- **触发条件**: 
  - 音频文件损坏或无法读取
  - 网络音频流中断
  - 音频解码失败
  - 播放器内部错误

### 7. AudioHandler初始化错误
- **位置**: `lib/data/providers/player/player_provider.dart`
- **目的**: 监控音频服务初始化过程中的关键错误，帮助开发者快速定位音频服务问题
- **上报位置和上下文**:
  
  #### 7.1 获取AudioHandler单例失败
  - **位置**: `_getAudioHandler()` 方法中的第一个 `catch` 块
  - **上下文信息**: `error_phase: 'get_audio_handler_singleton'`
  
  #### 7.2 AudioHandler初始化失败
  - **位置**: `_getAudioHandler()` 方法中的第二个 `catch` 块
  - **上下文信息**: `error_phase: 'audio_handler_init'`
  
  #### 7.3 AudioHandler Provider初始化失败（包括超时）
  - **位置**: `audioHandler()` Provider 中的 `catch` 块
  - **上下文信息**: `error_phase: 'audio_handler_provider_init'`
- **触发条件**:
  - AudioService初始化失败
  - AudioHandler初始化超时（8秒）
  - 获取AudioHandler单例失败

## 三、错误上报说明

### 隐私保护
- **不记录敏感信息**: 所有错误上报都遵循隐私保护原则，不会记录：
  - 用户密码
  - 用户名（只记录是否有用户名，不记录具体用户名）
  - 其他个人隐私信息

### 追溯信息
为了帮助开发者快速定位问题，以下信息会被上报：
- **服务器URL**: 在登录错误和API错误中上报，用于追溯是哪个服务器出现问题
- **API路径**: 在API错误中上报，用于定位具体的API接口
- **当前状态**: 在播放器错误中上报当前播放状态，帮助理解错误发生的上下文

### 错误上报条件
- 只有在用户同意隐私协议后，错误才会被上报到友盟
- 如果友盟SDK未初始化，错误上报会被静默忽略，不会影响应用运行

## 四、错误处理流程

1. **错误发生**: 应用中的某个位置发生错误
2. **错误捕获**: 通过 try-catch、错误回调等方式捕获错误
3. **日志记录**: 使用 `Logger` 记录错误到本地日志
4. **错误上报**: 调用 `UmengService.reportError()` 或 `UmengService.reportErrorString()` 上报错误
5. **友盟处理**: 友盟U-APM SDK收集错误信息并上报到友盟后台
6. **问题分析**: 开发者可以在友盟后台查看错误统计和详情，快速定位问题

## 五、查看错误报告

开发者可以在友盟U-APM后台查看：
- 错误统计和趋势
- 错误详情（包括堆栈信息、上下文信息等）
- 错误发生的设备、系统版本等信息
- 错误发生的用户分布

## 六、注意事项

1. **不要上报敏感信息**: 确保所有上报的上下文信息都不包含用户密码、完整用户名等敏感信息
2. **错误上报不应阻塞业务**: 错误上报失败不应影响应用的正常运行
3. **合理使用上下文信息**: 只上报有助于定位问题的必要信息，避免上报过多无用信息
4. **定期检查错误报告**: 建议定期查看友盟后台的错误报告，及时发现和修复问题
