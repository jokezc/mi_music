我将为您实现自定义歌单功能。根据您的需求，我制定了以下实施计划：

## 1. 基础架构与数据存储

### 1.1 修改 `SharedPrefKeys`

* 在 `lib/core/constants/shared_pref_keys.dart` 中添加两个新 Key：

  * `playlist_sort_order`: 用于存储用户自定义的歌单顺序列表。

  * `playlist_hidden_state`: 用于存储被隐藏的歌单名称列表。

### 1.2 增强 `PlaylistController`

* 在 `lib/data/providers/playlist_provider.dart` 中：

  * 提取 `systemPlaylistNames` 为公共常量。

  * 扩展 `PlaylistController` 或创建新的 `PlaylistManagerProvider`，增加对本地存储状态（排序、隐藏）的管理方法：

    * `updateSortOrder(List<String> newOrder)`

    * `togglePlaylistVisibility(String name)`

    * `batchDelete(List<String> names)`

  * 创建一个新的组合 Provider `displayPlaylistsProvider`，它将：

    * 合并 API 返回的歌单列表与本地排序/隐藏状态。

    * 处理“收藏”和“新增歌单”的默认置顶逻辑。

    * 为 UI 提供最终的显示列表。

## 2. 界面改造

### 2.1 改造 `LibraryPage` (`lib/presentation/pages/library/library_page.dart`)

* **AppBar 更新**：

  * 将原本的刷新按钮替换为 `Icons.add` 图标。

  * 点击图标弹出 `PopupMenuButton`，包含三个选项：

    1. **新增歌单**：点击弹出对话框输入名称。
    2. **管理歌单**：跳转到新页面。
    3. **刷新歌单**：保留原有的刷新逻辑。

* **列表显示更新**：

  * 使用新的 `displayPlaylistsProvider` 替换原有的 `cachedPlaylistNamesProvider`，自动过滤已隐藏的歌单并按自定义顺序排列。

### 2.2 新增 `ManagePlaylistsPage` (`lib/presentation/pages/library/manage_playlists_page.dart`)

* 创建一个新的页面用于全功能管理：

  * **列表展示**：使用 `ReorderableListView` 实现拖拽排序。

  * **列表项设计**：

    * 左侧：拖拽手柄。

    * 中间：歌单名称 + “系统”标签（针对系统歌单）。

    * 右侧：可见性开关（眼睛图标） + 删除复选框（仅自定义歌单）。

  * **底部操作栏**：当有选中项时显示“批量删除”按钮。

  * **实时保存**：排序和隐藏状态的改变将实时写入本地存储。

### 2.3 交互组件

* **创建**：

  * 实现输入验证（不能为空）。

  * 调用对应的 API (`/playlistadd`)。

  * 成功/失败后显示 `SnackBar` 提示。

## 3. 业务逻辑细节

* **排序规则**：

  * 默认：收藏 > 自定义歌单（按名称） > 系统歌单。

  * 自定义：用户拖拽后的顺序优先，未记录顺序的新歌单默认插入到收藏之后。

* **系统歌单保护**：

  * 系统歌单在管理页会有明显 Tag 标识。

  * 系统歌单不允许删除和重命名。

* **数据一致性**：

  * 每次 API 操作（增删改）成功后，自动触发列表刷新和本地状态的清理（如移除已删除歌单的排序记录）。

## 4. 验证计划

* 验证新增歌单流程，确保 API 调用成功且列表自动刷新。

* 验证管理页面的拖拽排序功能，重启 App 后顺序是否保持。

* 验证隐藏功能，确保隐藏后主页不再显示，但管理页可见。

* 验证系统歌单的不可删除/重命名限制。

